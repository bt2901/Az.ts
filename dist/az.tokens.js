import{Az}from"./az";let TLDs="ac|ad|ae|aero|af|ag|ai|al|am|ao|aq|ar|arpa|as|asia|at|au|aw|ax|az|ba|bb|be|bf|bg|bh|bi|biz|bj|bm|bo|br|bs|bt|bv|bw|by|bz|ca|cat|cc|cd|cf|cg|ch|ci|cl|cm|cn|co|com|coop|cr|cu|cv|cw|cx|cz|de|dj|dk|dm|do|dz|ec|edu|ee|eg|es|et|eu|fi|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gov|gp|gq|gr|gs|gt|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|info|int|io|iq|ir|is|it|je|jo|jobs|jp|kg|ki|km|kn|kp|kr|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mil|mk|ml|mn|mo|mobi|mp|mq|mr|ms|mt|mu|museum|mv|mw|mx|my|na|name|nc|ne|net|nf|ng|nl|no|nr|nu|nz|om|org|pa|pe|pf|ph|pk|pl|pm|pn|post|pr|pro|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sx|sy|sz|tc|td|tel|tf|tg|th|tj|tk|tl|tm|tn|to|tr|travel|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|yt|امارات|հայ|বাংলা|бел|中国|中國|الجزائر|مصر|ею|გე|ελ|香港|भारत|بھارت|భారత్|ભારત|ਭਾਰਤ|ভারত|இந்தியா|ایران|ايران|عراق|الاردن|한국|қаз|ලංකා|இலங்கை|المغرب|мкд|мон|澳門|澳门|مليسيا|عمان|پاکستان|پاكستان|فلسطين|срб|рф|قطر|السعودية|السعودیة|السعودیۃ|السعوديه|سودان|新加坡|சிங்கப்பூர்|سورية|سوريا|ไทย|تونس|台灣|台湾|臺灣|укр|اليمن|xxx|zm|aaa|aarp|abarth|abb|abbott|abbvie|abc|able|abogado|abudhabi|academy|accenture|accountant|accountants|aco|active|actor|adac|ads|adult|aeg|aetna|afamilycompany|afl|africa|africamagic|agakhan|agency|aig|aigo|airbus|airforce|airtel|akdn|alfaromeo|alibaba|alipay|allfinanz|allstate|ally|alsace|alstom|americanexpress|americanfamily|amex|amfam|amica|amsterdam|analytics|android|anquan|anz|aol|apartments|app|apple|aquarelle|arab|aramco|archi|army|art|arte|asda|associates|athleta|attorney|auction|audi|audible|audio|auspost|author|auto|autos|avianca|aws|axa|azure|baby|baidu|banamex|bananarepublic|band|bank|bar|barcelona|barclaycard|barclays|barefoot|bargains|baseball|basketball|bauhaus|bayern|bbc|bbt|bbva|bcg|bcn|beats|beauty|beer|bentley|berlin|best|bestbuy|bet|bharti|bible|bid|bike|bing|bingo|bio|black|blackfriday|blanco|blockbuster|blog|bloomberg|blue|bms|bmw|bnl|bnpparibas|boats|boehringer|bofa|bom|bond|boo|book|booking|boots|bosch|bostik|boston|bot|boutique|box|bradesco|bridgestone|broadway|broker|brother|brussels|budapest|bugatti|build|builders|business|buy|buzz|bzh|cab|cafe|cal|call|calvinklein|camera|camp|cancerresearch|canon|capetown|capital|capitalone|car|caravan|cards|care|career|careers|cars|cartier|casa|case|caseih|cash|casino|catering|catholic|cba|cbn|cbre|cbs|ceb|center|ceo|cern|cfa|cfd|chanel|channel|chase|chat|cheap|chintai|chloe|christmas|chrome|chrysler|church|cipriani|circle|cisco|citadel|citi|citic|city|cityeats|claims|cleaning|click|clinic|clinique|clothing|cloud|club|clubmed|coach|codes|coffee|college|cologne|comcast|commbank|community|company|compare|computer|comsec|condos|construction|consulting|contact|contractors|cooking|cookingchannel|cool|corsica|country|coupon|coupons|courses|credit|creditcard|creditunion|cricket|crown|crs|cruise|cruises|csc|cuisinella|cymru|cyou|dabur|dad|dance|date|dating|datsun|day|dclk|dds|deal|dealer|deals|degree|delivery|dell|deloitte|delta|democrat|dental|dentist|desi|design|dev|dhl|diamonds|diet|digital|direct|directory|discount|discover|dish|diy|dnp|docs|dodge|dog|doha|domains|dot|download|drive|dstv|dtv|dubai|duck|dunlop|duns|dupont|durban|dvag|dwg|earth|eat|edeka|education|email|emerck|emerson|energy|engineer|engineering|enterprises|epost|epson|equipment|ericsson|erni|esq|estate|esurance|etisalat|eurovision|eus|events|everbank|exchange|expert|exposed|express|extraspace|fage|fail|fairwinds|faith|family|fan|fans|farm|farmers|fashion|fast|fedex|feedback|ferrari|ferrero|fiat|fidelity|fido|film|final|finance|financial|fire|firestone|firmdale|fish|fishing|fit|fitness|flickr|flights|flir|florist|flowers|flsmidth|fly|foo|foodnetwork|football|ford|forex|forsale|forum|foundation|fox|free|fresenius|frl|frogans|frontdoor|frontier|ftr|fujitsu|fujixerox|fun|fund|furniture|futbol|fyi|gal|gallery|gallo|gallup|game|games|gap|garden|gbiz|gdn|gea|gent|genting|george|ggee|gift|gifts|gives|giving|glade|glass|gle|global|globo|gmail|gmbh|gmo|gmx|godaddy|gold|goldpoint|golf|goo|goodhands|goodyear|goog|google|gop|got|gotv|grainger|graphics|gratis|green|gripe|group|guardian|gucci|guge|guide|guitars|guru|hair|hamburg|hangout|haus|hbo|hdfc|hdfcbank|health|healthcare|help|helsinki|here|hermes|hgtv|hiphop|hisamitsu|hitachi|hiv|hkt|hockey|holdings|holiday|homedepot|homegoods|homes|homesense|honda|honeywell|horse|host|hosting|hot|hoteles|hotmail|house|how|hsbc|htc|hughes|hyatt|hyundai|ibm|icbc|ice|icu|ieee|ifm|iinet|ikano|imamat|imdb|immo|immobilien|industries|infiniti|ing|ink|institute|insurance|insure|intel|international|intuit|investments|ipiranga|irish|iselect|ismaili|ist|istanbul|itau|itv|iveco|iwc|jaguar|java|jcb|jcp|jeep|jetzt|jewelry|jio|jlc|jll|jmp|jnj|joburg|jot|joy|jpmorgan|jprs|juegos|juniper|kaufen|kddi|kerryhotels|kerrylogistics|kerryproperties|kfh|kia|kim|kinder|kindle|kitchen|kiwi|koeln|komatsu|kosher|kpmg|kpn|krd|kred|kuokgroup|kyknet|kyoto|lacaixa|ladbrokes|lamborghini|lamer|lancaster|lancia|lancome|land|landrover|lanxess|lasalle|lat|latino|latrobe|law|lawyer|lds|lease|leclerc|lefrak|legal|lego|lexus|lgbt|liaison|lidl|life|lifeinsurance|lifestyle|lighting|like|lilly|limited|limo|lincoln|linde|link|lipsy|live|living|lixil|loan|loans|locker|locus|loft|lol|london|lotte|lotto|love|lpl|lplfinancial|ltd|ltda|lundbeck|lupin|luxe|luxury|macys|madrid|maif|maison|makeup|man|management|mango|market|marketing|markets|marriott|marshalls|maserati|mattel|mba|mcd|mcdonalds|mckinsey|med|media|meet|melbourne|meme|memorial|men|menu|meo|metlife|miami|microsoft|mini|mint|mit|mitsubishi|mlb|mls|mma|mnet|mobily|moda|moe|moi|mom|monash|money|monster|montblanc|mopar|mormon|mortgage|moscow|moto|motorcycles|mov|movie|movistar|msd|mtn|mtpc|mtr|multichoice|mutual|mutuelle|mzansimagic|nab|nadex|nagoya|naspers|nationwide|natura|navy|nba|nec|netbank|netflix|network|neustar|new|newholland|news|next|nextdirect|nexus|nfl|ngo|nhk|nico|nike|nikon|ninja|nissan|nissay|nokia|northwesternmutual|norton|now|nowruz|nowtv|nra|nrw|ntt|nyc|obi|observer|off|office|okinawa|olayan|olayangroup|oldnavy|ollo|omega|one|ong|onl|online|onyourside|ooo|open|oracle|orange|organic|orientexpress|origins|osaka|otsuka|ott|ovh|page|pamperedchef|panasonic|panerai|paris|pars|partners|parts|party|passagens|pay|payu|pccw|pet|pfizer|pharmacy|philips|photo|photography|photos|physio|piaget|pics|pictet|pictures|pid|pin|ping|pink|pioneer|pizza|place|play|playstation|plumbing|plus|pnc|pohl|poker|politie|porn|pramerica|praxi|press|prime|prod|productions|prof|progressive|promo|properties|property|protection|pru|prudential|pub|pwc|qpon|quebec|quest|qvc|racing|raid|read|realestate|realtor|realty|recipes|red|redstone|redumbrella|rehab|reise|reisen|reit|reliance|ren|rent|rentals|repair|report|republican|rest|restaurant|review|reviews|rexroth|rich|richardli|ricoh|rightathome|ril|rio|rip|rmit|rocher|rocks|rodeo|rogers|room|rsvp|ruhr|run|rwe|ryukyu|saarland|safe|safety|sakura|sale|salon|samsclub|samsung|sandvik|sandvikcoromant|sanofi|sap|sapo|sarl|sas|save|saxo|sbi|sbs|sca|scb|schaeffler|schmidt|scholarships|school|schule|schwarz|science|scjohnson|scor|scot|seat|secure|security|seek|select|sener|services|ses|seven|sew|sex|sexy|sfr|shangrila|sharp|shaw|shell|shia|shiksha|shoes|shopping|shouji|show|showtime|shriram|silk|sina|singles|site|ski|skin|sky|skype|sling|smart|smile|sncf|soccer|social|softbank|software|sohu|solar|solutions|song|sony|soy|space|spiegel|spot|spreadbetting|srl|srt|stada|staples|star|starhub|statebank|statefarm|statoil|stc|stcgroup|stockholm|storage|store|stream|studio|study|style|sucks|supersport|supplies|supply|support|surf|surgery|suzuki|swatch|swiftcover|swiss|sydney|symantec|systems|tab|taipei|talk|taobao|target|tatamotors|tatar|tattoo|tax|taxi|tci|tdk|team|tech|technology|telecity|telefonica|temasek|tennis|teva|thd|theater|theatre|theguardian|tiaa|tickets|tienda|tiffany|tips|tires|tirol|tjmaxx|tjx|tkmaxx|tmall|today|tokyo|tools|top|toray|toshiba|total|tours|town|toyota|toys|trade|trading|training|travelchannel|travelers|travelersinsurance|trust|trv|tube|tui|tunes|tushu|tvs|ubank|ubs|uconnect|unicom|university|uno|uol|ups|vacations|vana|vanguard|vegas|ventures|verisign|versicherung|vet|viajes|video|vig|viking|villas|vin|vip|virgin|visa|vision|vista|vistaprint|viva|vivo|vlaanderen|vodka|volkswagen|volvo|vote|voting|voto|voyage|vuelos|wales|walmart|walter|wang|wanggou|warman|watch|watches|weather|weatherchannel|webcam|weber|website|wed|wedding|weibo|weir|whoswho|wien|wiki|williamhill|win|windows|wine|winners|wme|wolterskluwer|woodside|work|works|world|wow|wtc|wtf|xbox|xerox|xfinity|xihuan|xin|कॉम|セール|佛山|慈善|集团|在线|大众汽车|点看|คอม|八卦|موقع|一号店|公益|公司|香格里拉|网站|移动|我爱你|москва|католик|онлайн|сайт|联通|קום|时尚|微博|淡马锡|ファッション|орг|नेट|ストア|삼성|商标|商店|商城|дети|ポイント|新闻|工行|家電|كوم|中文网|中信|娱乐|谷歌|電訊盈科|购物|クラウド|通販|网店|संगठन|餐厅|网络|ком|诺基亚|食品|飞利浦|手表|手机|ارامكو|العليان|اتصالات|بازار|موبايلي|ابوظبي|كاثوليك|همراه|닷컴|政府|شبكة|بيتك|عرب|机构|组织机构|健康|рус|珠宝|大拿|みんな|グーグル|世界|書籍|网址|닷넷|コム|天主教|游戏|vermögensberater|vermögensberatung|企业|信息|嘉里大酒店|嘉里|广东|政务|xperia|xyz|yachts|yahoo|yamaxun|yandex|yodobashi|yoga|yokohama|you|youtube|yun|zappos|zara|zero|zip|zippo|zone|zuerich".split("|"),defaults_tokens={html:!1,wiki:!1,markdown:!1,hashtags:!0,mentions:!0,emails:!0,links:{protocols:!0,www:!1,tlds:{}}},HTML_ENTITIES={nbsp:" ",quot:'"',gt:">",lt:"<",amp:"&",ndash:"–"};for(let e=0;e<TLDs.length;e++)defaults_tokens.links.tlds[TLDs[e]]=!0;let Token=function(e,t,n,s,o,i,a,r){this.source=e,this.st=t,this.length=n,this.index=s,this.firstUpper=o,this.allUpper=i,this.type=a,r&&(this.subType=r)};Token.prototype.toString=function(){return"_str"in this&&this._str.length==this.length?this._str:this._str=this.source.substr(this.st,this.length)},Token.prototype.indexOf=function(e){if(1==e.length){for(let t=0;t<this.length;t++)if(this.source[this.st+t]==e)return t;return-1}return this.toString().indexOf(e)},Token.prototype.toLowerCase=function(){return this.toString().toLocaleLowerCase()},Token.prototype.isCapitalized=function(){return this.firstUpper&&!this.allUpper},Token.prototype.en=function(){return this.st+this.length-1};export let Tokens=function(e,t){if(!(this instanceof Tokens))return new Tokens(e,t);this.tokens=[],this.source="","string"==typeof e?(this.config=t?Az.extend(defaults_tokens,t):defaults_tokens,this.append(e)):this.config=e?Az.extend(defaults_tokens,e):defaults_tokens,this.index=-1};function alwaysTrue(){return!0}function getMatcher(e,t){if(!e)return alwaysTrue();if("function"==typeof e)return e;let n,s=e;if("length"in e){n=!t,s={};for(let t=0;t<e.length;t++)s[e[t]]=!0}else n=t,t=!1;return function(e,o,i){if(e.subType){let n=e.type+"."+e.subType;if(n in s)return s[n]!=t}return e.type in s?s[e.type]!=t:!n}}Tokens.WORD=new String("WORD"),Tokens.NUMBER=new String("NUMBER"),Tokens.OTHER=new String("OTHER"),Tokens.DIGIT=new String("DIGIT"),Tokens.CYRIL=new String("CYRIL"),Tokens.LATIN=new String("LATIN"),Tokens.MIXED=new String("MIXED"),Tokens.PUNCT=new String("PUNCT"),Tokens.SPACE=new String("SPACE"),Tokens.MARKUP=new String("MARKUP"),Tokens.NEWLINE=new String("NEWLINE"),Tokens.EMAIL=new String("EMAIL"),Tokens.LINK=new String("LINK"),Tokens.HASHTAG=new String("HASHTAG"),Tokens.MENTION=new String("MENTION"),Tokens.TAG=new String("TAG"),Tokens.CONTENT=new String("CONTENT"),Tokens.SCRIPT=new String("SCRIPT"),Tokens.STYLE=new String("STYLE"),Tokens.COMMENT=new String("COMMENT"),Tokens.CLOSING=new String("CLOSING"),Tokens.TEMPLATE=new String("TEMPLATE"),Tokens.RANGE=new String("RANGE"),Tokens.ENTITY=new String("ENTITY"),Tokens.prototype.append=function(e,t){"use strict";(t=t?Az.extend(this.config,t):this.config).links&&!0===t.links.tlds&&(t.links.tlds=defaults_tokens.links.tlds);let n=this.source.length;this.source+=e;let s=this.source,o=this.tokens;for(let e=n;e<s.length;e++){let n=s[e],i=s.charCodeAt(e),a=!1,r=o.length-1,l=o[r],c=e;if(t.html&&";"==n)if(r>0&&l.type===Tokens.WORD&&1==o[r-1].length&&"&"==s[o[r-1].st]){let e=l.toLowerCase();e in HTML_ENTITIES&&(n=HTML_ENTITIES[e],i=n.charCodeAt(0),r-=2,l=o[r],o.length=r+1)}else r>1&&(l.type===Tokens.NUMBER||l.type===Tokens.WORD&&"x"==s[l.st])&&1==o[r-1].length&&"#"==s[o[r-1].st]&&1==o[r-1].length&&"&"==s[o[r-1].st]&&(i="x"==s[l.st]?parseInt(l.toString().substr(1),16):parseInt(l.toString(),10),n=String.fromCharCode(i),r-=3,l=o[r],o.length=r+1);let p=Tokens.OTHER,h=n.toLocaleLowerCase()!=n;i>=1024&&i<=1279&&(p=Tokens.CYRIL),(i>=65&&i<=90||i>=97&&i<=122||i>=192&&i<=591)&&(p=Tokens.LATIN),i>=48&&i<=57&&(p=Tokens.DIGIT),(i<=32||i>=128&&i<=160)&&(p=Tokens.SPACE),"‐-−‒–—―.…,:;?!¿¡()[]«»\"'’‘’“”/⁄".indexOf(n)>-1&&(p=Tokens.PUNCT);let g=p,k=!1;p===Tokens.CYRIL||p===Tokens.LATIN?(g=Tokens.WORD,k=p):p===Tokens.DIGIT&&(g=Tokens.NUMBER);let u=!l||"\n"==s[l.st+l.length-1];if(t.wiki&&(u&&":;*#~|".indexOf(n)>-1&&(g=Tokens.MARKUP,k=Tokens.NEWLINE),"={[|]}".indexOf(n)>-1&&(g=Tokens.MARKUP)),t.markdown&&(u&&"=-#>+-".indexOf(n)>-1&&(g=Tokens.MARKUP,k=Tokens.NEWLINE),"[]*~_`\\".indexOf(n)>-1&&(g=Tokens.MARKUP)),l)if(t.wiki&&"'"!=n&&1==l.length&&"'"==s[l.st]&&r>0&&o[r-1].type===Tokens.WORD&&o[r-1].subType===Tokens.LATIN&&(o[r-1].length+=l.length,r-=1,o.length=r+1,l=o[r]),t.links&&t.links.tlds&&(p===Tokens.PUNCT||p===Tokens.SPACE)&&o.length>2&&o[r-2].type===Tokens.WORD&&1==o[r-1].length&&"."==s[o[r-1].st]&&o[r].type===Tokens.WORD&&l.toString()in t.links.tlds){for(;r>=2&&o[r-2].type===Tokens.WORD&&1==o[r-1].length&&("."==s[o[r-1].st]||"@"==s[o[r-1].st]||":"==s[o[r-1].st]);)r-=2,l=o[r],l.length+=o[r+1].length+o[r+2].length,l.allUpper=l.allUpper&&o[r+1].allUpper&&o[r+2].allUpper;t.emails&&l.indexOf("@")>-1&&-1==l.indexOf(":")?l.type=Tokens.EMAIL:(l.type=Tokens.LINK,"/"==n&&(a=!0)),o.length=r+1}else if(l.type===Tokens.LINK)")"==n&&r>=1&&o[r-1].type===Tokens.MARKUP&&1==o[r-1].length&&"("==s[o[r-1].st]?g=Tokens.MARKUP:p!==Tokens.SPACE&&","!=n&&"<"!=n&&(a=!0);else if(l.type===Tokens.EMAIL)p!==Tokens.CYRIL&&p!==Tokens.LATIN&&"."!=n||(a=!0);else if(l.type===Tokens.HASHTAG||l.type===Tokens.MENTION)(p===Tokens.CYRIL||p==Tokens.LATIN||p==Tokens.DIGIT||"_"==n||"@"==n&&-1==l.indexOf("@"))&&(a=!0);else if(l.type!==Tokens.TAG||!l.quote&&">"==s[l.en()])if(l.type===Tokens.CONTENT)a=!0,l.quote?n==l.quote&&"\\"!=s[l.en()]&&delete l.quote:'"'==n||"'"==n?l.quote=n:">"==n&&(l.length>=8&&"</script"==l.toString().substr(-8)?(l.length-=8,c-=8,a=!1,g=Tokens.TAG,k=Tokens.CLOSING):l.length>=7&&"</style"==l.toString().substr(-7)&&(l.length-=7,c-=7,a=!1,g=Tokens.TAG,k=Tokens.CLOSING));else if(l.type===Tokens.TAG&&l.type!==Tokens.CLOSING&&l.length>=8&&"script"==l.toLowerCase().substr(1,6))g=Tokens.CONTENT,k=Tokens.SCRIPT;else if(l.type===Tokens.TAG&&l.type!==Tokens.CLOSING&&l.length>=7&&"style"==l.toLowerCase().substr(1,5))g=Tokens.CONTENT,k=Tokens.STYLE;else if(!t.html||1!=l.length||"<"!=s[l.st]||p!==Tokens.LATIN&&"!"!=n&&"/"!=n)if(l.type===Tokens.CONTENT)a=!0;else if(l.type!==Tokens.MARKUP||l.subType!=Tokens.TEMPLATE||"}"==s[l.en()]&&"}"==s[l.en()-1]){if(l.type===Tokens.MARKUP&&l.type===Tokens.LINK&&")"!=s[l.en()])a=!0;else if(l.type===Tokens.MARKUP&&"`"==s[l.st]&&l.subType===Tokens.NEWLINE&&p===Tokens.LATIN)a=!0;else if(p===Tokens.CYRIL||p===Tokens.LATIN)l.type===Tokens.WORD?(a=!0,l.subType=l.subType==p?l.subType:Tokens.MIXED):l.type===Tokens.NUMBER?(a=!0,l.subType=l.subType&&l.subType!=p?Tokens.MIXED:p):t.hashtags&&1==l.length&&"#"==s[l.st]?(a=!0,l.type=Tokens.HASHTAG):!t.mentions||1!=l.length||"@"!=s[l.st]||0!=r&&o[r-1].type!==Tokens.SPACE?p!==Tokens.LATIN||1!=l.length||"'"!=s[l.st]&&"’"!=s[l.st]?1==l.length&&"-"==s[l.st]&&(a=!0,r>0&&o[r-1].type===Tokens.NUMBER&&(l=o[r-1],l.length+=o[r].length,o.length-=1),l.type=Tokens.WORD,l.subType=p):(a=!0,l.type=Tokens.WORD,l.subType=Tokens.LATIN):(a=!0,l.type=Tokens.MENTION);else if(p===Tokens.DIGIT)l.type===Tokens.WORD?(a=!0,l.subType=Tokens.MIXED):l.type===Tokens.NUMBER?a=!0:1!=l.length||"+"!=s[l.st]&&"-"!=s[l.st]?1==l.length&&(","==s[l.st]||"."==s[l.st])&&o.length>1&&o[r-1].type===Tokens.NUMBER&&(a=!0,l=o[r-1],l.length+=o[r].length,o.length-=1):(a=!0,r>0&&o[r-1].type===Tokens.NUMBER&&(l=o[r-1],l.length+=o[r].length,l.subType=Tokens.RANGE,o.length-=1),l.type=Tokens.NUMBER);else if(p===Tokens.SPACE)l.type===Tokens.SPACE&&(a=!0);else if(l.type===Tokens.MARKUP&&s[l.st]==n&&"=-~:*#`'>_".indexOf(n)>-1)a=!0;else if("."==n)t.links&&t.links.www&&3==l.length&&"www"==l.toLowerCase()&&(a=!0,l.type=Tokens.LINK);else if(t.wiki&&"'"==n&&"'"==s[l.en()])l.length>1?(l.length--,c--,g=Tokens.MARKUP):(a=!0,l.type=Tokens.MARKUP);else if("-"==n||l.subType==Tokens.LATIN&&("’"==n||"'"==n))l.type===Tokens.WORD&&(a=!0);else if("/"==n)t.links&&t.links.protocols&&o.length>2&&o[r-2].type===Tokens.WORD&&o[r-2].subType==Tokens.LATIN&&1==o[r-1].length&&":"==s[o[r-1].st]&&1==o[r].length&&"/"==s[o[r].st]&&(a=!0,l=o[r-2],l.length+=o[r-1].length+o[r].length,l.allUpper=l.allUpper&&o[r-1].allUpper&&o[r].allUpper,l.type=Tokens.LINK,o.length-=2);else if(t.html&&";"==n)r>0&&l.type===Tokens.WORD&&1==o[r-1].length&&"&"==s[o[r-1].st]?(a=!0,l=o[r-1],l.length+=o[r].length,l.allUpper=l.allUpper&&o[r-1].allUpper,l.type=Tokens.ENTITY,o.length-=1):r>1&&(l.type===Tokens.WORD||l.type===Tokens.NUMBER)&&1==o[r-1].length&&"#"==s[o[r-1].st]&&1==o[r-2].length&&"&"==s[o[r-2].st]&&(a=!0,l=o[r-2],l.length+=o[r-1].length+o[r].length,l.allUpper=l.allUpper&&o[r-1].allUpper&&o[r].allUpper,l.type=Tokens.ENTITY,o.length-=2);else if(t.markdown&&"["==n&&1==l.length&&"!"==s[l.st])a=!0,l.type=Tokens.MARKUP;else if(t.markdown&&"("==n&&1==l.length&&"]"==s[l.st])g=Tokens.MARKUP,k=Tokens.LINK;else if(t.wiki&&"{"==n&&1==l.length&&"{"==s[l.st])a=!0,l.type=Tokens.MARKUP,l.subType=Tokens.TEMPLATE;else if(t.wiki&&"["==n&&1==l.length&&"["==s[l.st])a=!0;else if(t.wiki&&"]"==n&&1==l.length&&"]"==s[l.st])a=!0;else if(t.wiki&&"|"==n&&!u){let e=-1;for(let t=r-1;t>=0;t--){if(2==o[t].length&&"["==s[o[t].st]&&"["==s[o[t].st+1]){e=t;break}if(1==o[t].length&&"|"==s[o[t].st]||o[t].indexOf("\n")>-1)break}if(e>-1){a=!0;for(let t=r-1;t>=e;t--)l=o[t],l.length+=o[t+1].length,l.allUpper=l.allUpper&&o[t+1].allUpper;r=e,o.length=r+1,l.subType=Tokens.LINK}}}else a=!0;else a=!0,l.type=Tokens.TAG,"!"==n?l.subType=Tokens.COMMENT:"/"==n&&(l.subType=Tokens.CLOSING);else a=!0,l.quote?n==l.quote&&"\\"!=s[l.en()]&&delete l.quote:'"'!=n&&"'"!=n||(l.quote=n);a?(l.length++,l.allUpper=l.allUpper&&h):(l=new Token(s,c,e+1-c,o.length,h,h,g,k),o.push(l))}return this},Tokens.prototype.done=function(e,t){if(!e)return this.tokens;let n=getMatcher(e,t),s=[];for(let e=0;e<this.tokens.length;e++)n(this.tokens[e],e,this.tokens)&&s.push(this.tokens[e]);return s},Tokens.prototype.get=function(e,t,n){if(e<0)return!1;if(!t)return this.tokens[e];let s=getMatcher(t,n),o=0;for(let t=0;t<this.tokens.length;t++)if(s(this.tokens[t],t,this.tokens)){if(o==e)return this.tokens[t];o++}return!1},Tokens.prototype.count=function(e,t){if(!e)return this.tokens.length;let n=getMatcher(e,t),s=0;for(let e=0;e<this.tokens.length;e++)n(this.tokens[e],e,this.tokens)&&s++;return s},Tokens.prototype.nextToken=function(e,t,n){let s=getMatcher(t,n),o=this.index;for(o++;o<this.tokens.length&&s(this.tokens[o],o,this.tokens);)o++;return o<this.tokens.length?(e&&(this.index=o),this.tokens[o]):null},Tokens.prototype.punctAhead=function(){let e=this.nextToken(!1,["SPACE"],!0);return e&&"PUNCT"==e.type&&e},Tokens.prototype.prevToken=function(e,t,n){let s=getMatcher(t,n),o=this.index;for(o--;o>=0&&s(this.tokens[o],o,this.tokens);)o--;return o>=0?(e&&(this.index=o),this.tokens[o]):null},Tokens.prototype.punctBehind=function(){let e=this.prevToken(!1,["SPACE"],!0);return e&&"PUNCT"==e.type&&e},Tokens.prototype.hasTokensAhead=function(e,t){return null!=this.nextToken(!1,e,t)},Tokens.prototype.hasTokensBehind=function(e,t){return null!=this.prevToken(!1,e,t)};