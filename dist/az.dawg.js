import{Az}from"./az";let ROOT=0,MISSING=-1,PRECISION_MASK=4294967295,HAS_LEAF_BIT=256,EXTENSION_BIT=512,OFFSET_MAX=1<<21,IS_LEAF_BIT=1<<31,CP1251={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,11:11,12:12,13:13,14:14,15:15,16:16,17:17,18:18,19:19,20:20,21:21,22:22,23:23,24:24,25:25,26:26,27:27,28:28,29:29,30:30,31:31,32:32,33:33,34:34,35:35,36:36,37:37,38:38,39:39,40:40,41:41,42:42,43:43,44:44,45:45,46:46,47:47,48:48,49:49,50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,58:58,59:59,60:60,61:61,62:62,63:63,64:64,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,87:87,88:88,89:89,90:90,91:91,92:92,93:93,94:94,95:95,96:96,97:97,98:98,99:99,100:100,101:101,102:102,103:103,104:104,105:105,106:106,107:107,108:108,109:109,110:110,111:111,112:112,113:113,114:114,115:115,116:116,117:117,118:118,119:119,120:120,121:121,122:122,123:123,124:124,125:125,126:126,127:127,1027:129,8225:135,1046:198,8222:132,1047:199,1168:165,1048:200,1113:154,1049:201,1045:197,1050:202,1028:170,160:160,1040:192,1051:203,164:164,166:166,167:167,169:169,171:171,172:172,173:173,174:174,1053:205,176:176,177:177,1114:156,181:181,182:182,183:183,8221:148,187:187,1029:189,1056:208,1057:209,1058:210,8364:136,1112:188,1115:158,1059:211,1060:212,1030:178,1061:213,1062:214,1063:215,1116:157,1064:216,1065:217,1031:175,1066:218,1067:219,1068:220,1069:221,1070:222,1032:163,8226:149,1071:223,1072:224,8482:153,1073:225,8240:137,1118:162,1074:226,1110:179,8230:133,1075:227,1033:138,1076:228,1077:229,8211:150,1078:230,1119:159,1079:231,1042:194,1080:232,1034:140,1025:168,1081:233,1082:234,8212:151,1083:235,1169:180,1084:236,1052:204,1085:237,1035:142,1086:238,1087:239,1088:240,1089:241,1090:242,1036:141,1041:193,1091:243,1092:244,8224:134,1093:245,8470:185,1094:246,1054:206,1095:247,1096:248,8249:139,1097:249,1098:250,1044:196,1099:251,1111:191,1055:207,1100:252,1038:161,8220:147,1101:253,8250:155,1102:254,8216:145,1103:255,1043:195,1105:184,1039:143,1026:128,1106:144,8218:130,1107:131,8217:146,1108:186,1109:190},UCS2={};for(let t in CP1251)UCS2[CP1251[t]]=String.fromCharCode(+t),delete UCS2[0],delete UCS2[1];let COMMON_TYPOS={"й":"иёцыф","ц":"йфыву","у":"цывак","к":"увапе","е":"эикапрн","н":"епрог","г":"нролш","ш":"жголдщ","щ":"шлджз","з":"щджэх-","х":"зжэъ-","ъ":"ьхэ-ё","ф":"йцычяё","ы":"иойцувсчяф","в":"фцукамсчы","а":"оукепимсв","п":"кенртима","р":"енгоьтип","о":"ангшлбьтр","л":"гшщдюбьо","д":"шщзжюбл","ж":"шщзхэюд","э":"езхъжё","ё":"йфяъэ","я":"еёфыч","ч":"яфывс","с":"зчывам","м":"свапи","и":"йяемапрт","т":"дипроь","ь":"ътролб","б":"ьолдю","ю":"блдж",1:"ёйц",2:"йцу",3:"цук",4:"уке",5:"кен",6:"енг",7:"нгш",8:"гшщ",9:"шщз",0:"щзх-","-":"зхъ","=":"-хъ","\\":"ъэ",".":"южэ"};function offset(t){return t>>10<<((t&EXTENSION_BIT)>>6)&PRECISION_MASK}function label(t){return t&(255|IS_LEAF_BIT)&PRECISION_MASK}function hasLeaf(t){return 0!=(t&HAS_LEAF_BIT&PRECISION_MASK)}function value(t){return t&~IS_LEAF_BIT&PRECISION_MASK}export let DAWG=function(t,e,i){this.units=t,this.guide=e,this.format=i};DAWG.fromArrayBuffer=function(t,e){let i=new DataView(t),o=i.getUint32(0,!0),n=i.getUint32(4*o+4,!0);return new DAWG(new Uint32Array(t,4,o),new Uint8Array(t,4*o+8,2*n),e)},DAWG.load=function(t,e,i){Az.load(t,"arraybuffer",(function(t,o){i(t,t?null:DAWG.fromArrayBuffer(o,e))}))},DAWG.prototype.followByte=function(t,e){let i=(e^offset(this.units[e])^255&t)&PRECISION_MASK;return label(this.units[i])!=(255&t)?MISSING:i},DAWG.prototype.followString=function(t,e){e=e||ROOT;for(let i=0;i<t.length;i++){let o=t.charCodeAt(i);if(!(o in CP1251))return MISSING;if((e=this.followByte(CP1251[o],e))==MISSING)return MISSING}return e},DAWG.prototype.hasValue=function(t){return hasLeaf(this.units[t])},DAWG.prototype.value=function(t){let e=(t^offset(this.units[t]))&PRECISION_MASK;return value(this.units[e])},DAWG.prototype.find=function(t){let e=this.followString(t);return e==MISSING?MISSING:this.hasValue(e)?this.value(e):MISSING},DAWG.prototype.iterateAll=function(t){let e,i=[],o=[t],n=[],r=ROOT;for(;;){if(t=o[o.length-1],r!=ROOT)if(e=this.guide[t<<1],e){if((t=this.followByte(e,t))==MISSING)return i;n.push(e),o.push(t)}else do{if(e=this.guide[1+(t<<1)],n.pop(),o.pop(),!o.length)return i;if(t=o[o.length-1],e){if((t=this.followByte(e,t))==MISSING)return i;n.push(e),o.push(t)}}while(!e);for(;!this.hasValue(t);){let e=this.guide[t<<1];if(t=this.followByte(e,t),t==MISSING)return i;n.push(e),o.push(t)}"words"==this.format?i.push([((1^n[0])<<6)+(n[1]>>1),((1^n[2])<<6)+(n[3]>>1)]):"probs"==this.format?i.push([((1^n[0])<<6)+(n[1]>>1),((1^n[2])<<6)+(n[3]>>1),((1^n[4])<<6)+(n[5]>>1)]):i.push(n.slice()),r=t}},DAWG.prototype.findAll=function(t,e,i,o){o=o||0,i=i||0;let n,r,l,h,s,f,u,S=[],I=[["",0,0,0,ROOT]];for(;I.length;)if(n=I.pop(),r=n[4],u=n[3],f=n[2],l=n[1],n=n[0],l!=t.length){if(e&&t[l]in e&&(h=e[t[l]].charCodeAt(0),h in CP1251&&(s=this.followByte(CP1251[h],r),s!=MISSING&&I.push([n+e[t[l]],l+1,f,u,s]))),f<o&&u<=i){I.push([n,l+1,f+1,u,r]);let e=this.guide[r<<1];do{s=this.followByte(e,r),s!=MISSING&&e in UCS2&&I.push([n+UCS2[e],l,f+1,u,s]),e=this.guide[1+(s<<1)]}while(s!=MISSING);let i=COMMON_TYPOS[t[l]];if(i)for(let t=0;t<i.length;t++)h=i.charCodeAt(t),h in CP1251&&(s=this.followByte(CP1251[h],r),s!=MISSING&&I.push([n+i[t],l+1,f+1,u,s]));l<t.length-1&&(h=t.charCodeAt(l+1),h in CP1251&&(s=this.followByte(CP1251[h],r),s!=MISSING&&(h=t.charCodeAt(l),h in CP1251&&(s=this.followByte(CP1251[h],s),s!=MISSING&&I.push([n+t[l+1]+t[l],l+2,f+1,u,s])))))}if(h=t.charCodeAt(l),h in CP1251&&(s=this.followByte(CP1251[h],r),s!=MISSING))for(I.push([n+t[l],l+1,f,u,s]);u<i&&f<=o&&l<t.length-1;){if(t[l]==t[l+1])I.push([n+t[l],l+2,f,u+1,s]),l++;else{if(!(l<t.length-2&&"-"==t[l+1]&&t[l]==t[l+2]))break;I.push([n+t[l],l+3,f,u+1,s]),l+=2}u++}}else{if(f<o&&u<=i){let t=this.guide[r<<1];do{s=this.followByte(t,r),s!=MISSING&&t in UCS2&&I.push([n+UCS2[t],l,f+1,u,s]),t=this.guide[1+(s<<1)]}while(s!=MISSING)}if("int"==this.format){this.hasValue(r)&&S.push([n,this.value(r)]);continue}if(("words"==this.format||"probs"==this.format)&&(r=this.followByte(1,r),r==MISSING))continue;S.push([n,this.iterateAll(r),u,f])}return S};